下面给出**“把数学假轨迹 → 真实传感器字段”**的**最小修改路线图**：

- ① **字段映射表**（1-1 对照）  
- ② **三种常见数据源**（串口 / ROS / 文件）的**喂法模板**  
- ③ **时间戳对齐 & 丢包补偿**代码片段  
- ④ **一键切换**开关（demo ↔ 真实）

---

### ✅ 一、字段映射表（不变算法，只换数据源）

| 算法输入字段  | 真实传感器典型字段                      | 单位      | 必填/可选 | 备注                  |
| ------------- | --------------------------------------- | --------- | --------- | --------------------- |
| `t`           | `msg.timestamp` 或 `PPS + 计数`         | s         | ✅         | 必须单调递增          |
| `lat`         | `msg.lat` / `nav_sat_fix.latitude`      | °         | ✅         | WGS84                 |
| `lon`         | `msg.lon` / `nav_sat_fix.longitude`     | °         | ✅         | WGS84                 |
| `spd`         | `msg.ground_speed` / `vel_ned.horiz`    | m/s       | ✅         | 地速                  |
| `heading_deg` | `msg.heading` / `yaw * 180/pi`          | ° (0-360) | ✅         | 真北=0，顺时针        |
| `alt`         | `msg.altitude` / `nav_sat_fix.altitude` | m         | ⭕         | 无则上下机动=straight |
| `nav_flag`    | `msg.gps_health` / `gps.fix_type`       | enum      | ⭕         | 0=OK,1=退化,2=拒止    |

---

### ✅ 二、三种数据源喂法模板

#### 1. 串口（115200, 20 Hz）

```python
import serial, struct, time
from engine_instant import Model6Engine

ser = serial.Serial('/dev/ttyUSB0', 115200, timeout=0.1)
engine = Model6Engine(converter, costmap, goals)

while True:
    line = ser.readline()
    if not line: continue
    # 假设格式：timestamp,lat,lon,spd,heading,alt,fix
    ts, lat, lon, spd, hdg, alt, fix = map(float, line.decode().strip().split(','))
    nav_flag = {0: 'OK', 1: 'DEGRADED', 2: 'DENIED'}.get(int(fix), 'OK')
    engine.update_obs(track_id, ts, lat, lon, spd, hdg, alt)
    # 瞬时立刻算
    inst = engine.predict(track_id)[0]
    send_to_fire_control(inst)
```

#### 2. ROS 话题（Python 节点）

```python
#!/usr/bin/env python3
import rospy
from sensor_msgs.msg import NavSatFix, Imu
from engine_instant import Model6Engine

engine = Model6Engine(converter, costmap, goals)

def cb_nav(msg):
    # 时间戳
    ts = msg.header.stamp.to_sec()
    # 字段映射
    lat = msg.latitude
    lon = msg.longitude
    alt = msg.altitude
    # 从 IMU 拿 heading & 地速（示例）
    imu = rospy.wait_for_message('/imu/data', Imu, timeout=0.05)
    yaw = imu.orientation.z          # 假设已转欧拉角
    spd = math.hypot(imu.linear_velocity.x, imu.linear_velocity.y)
    # 喂
    engine.update_obs(track_id, ts, lat, lon, spd, degrees(yaw), alt)
    # 瞬时输出
    inst = engine.predict(track_id)[0]
    pub_inst.publish(json.dumps(inst))

rospy.init_node('model6_predictor')
sub = rospy.Subscriber('/gps/fix', NavSatFix, cb_nav)
pub_inst = rospy.Publisher('/model6/instant', String, queue_size=1)
rospy.spin()
```

#### 3. 离线 CSV / PCAP（批量验证）

```python
import pandas as pd
df = pd.read_csv('real_flight.csv')
for _, row in df.iterrows():
    engine.update_obs(track_id, row.t, row.lat, row.lon,
                      row.spd, row.heading, row.alt)
# 瞬时逐帧
inst_list = [engine.predict(track_id)[0] for _ in df.index]
# 长时 1 s 批量
for t in df.t.unique()[::20]:          # 1 Hz
    sub = df[df.t.between(t, t+1)]
    for _, r in sub.iterrows():
        long_eng.update_obs(track_id, r.t, r.lat, r.lon,
                            r.spd, r.heading, r.alt)
    out = long_eng.predict(track_id, [300, 600, 1800, 3600])
    save_csv(out)
```

---

### ✅ 三、时间戳对齐 & 丢包补偿

| 场景            | 代码片段                                                |
| --------------- | ------------------------------------------------------- |
| **PPS 对齐**    | `ts = msg.pps_sec + msg.counter * 0.05`                 |
| **丢包 1 帧**   | 线性插值 `lat = lat_prev + (lat_curr - lat_prev) * 0.5` |
| **连丢 > 3 帧** | 置 `nav_flag = 'DENIED'` 并 **×2 置信度**               |

```python
if gap > 3 * dt:
    engine.update_obs(track_id, t, lat, lon, spd, hdg, alt,
                      nav_flag='DENIED')   # 内部乘 2° 误差
```

---

### ✅ 四、一键切换开关（demo ↔ 真实）

在 `main()` 里加环境变量：

```python
import os
if os.getenv('MODEL6_REAL') == '1':
    source = RealDataSource()          # 串口/ROS/文件
else:
    source = FakeTrackGenerator()      # 数学轨迹

for pkt in source:
    engine_instant.update_obs(track_id, pkt.t, pkt.lat, pkt.lon,
                              pkt.spd, pkt.hdg, pkt.alt)
    inst = engine_instant.predict(track_id)[0]
    publish(inst)
```

**运行真实数据**：

```bash
export MODEL6_REAL=1
python your_node.py
```

---

### ✅ 五、一句话总结

> **字段 1-1 映射 → 回调里直接 `update_obs()` → 时间戳单调 + 丢包 3 帧标 DENIED**；  
> **瞬时 20 Hz 立刻出标签，长时 1 s 批量出意图**，**算法一行不动，只换数据源**！